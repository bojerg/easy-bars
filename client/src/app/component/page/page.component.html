<div id="page-container">
  <mat-toolbar id="page-toolbar" (click)="activePhrase.index = -1">
    <input type="text" name="page-title" id="page-title" placeholder="{{placeholderTitle}}" (change)="saveTitle(title.value)" (click)="placeholderTitle = ''" (blur)="placeholderTitle = page.title" #title>
    <div id="page-tools">
      <div id="undo-redo">
        <button disabled><mat-icon inline="true">undo</mat-icon></button>
        <button disabled><mat-icon inline="true">redo</mat-icon></button>
      </div>
      <button (click)="splitLyricsByWord()">Split by Word</button>
      <button (click)="deleteAll()">Delete All</button>
    </div>
    <button id="page-close" mat-raised-button color="primary" (click)="dialogRef.close()"><mat-icon>close</mat-icon></button>
  </mat-toolbar> 

  <div id="lyric-cards-container">
  @for (phrase of page.lyrics; track $index) {

    @if(activePhrase.mode === 'notepad' && activePhrase.index === $index && !$first) {
      <div class="break"></div>
    }

    <mat-card class="phrase-card" (click)="toggleActive($index)">
      
      @if(activePhrase.index !== $index) {
        <mat-card-title>{{ phrase.content }}</mat-card-title>
        <mat-card-footer>Length: {{ phrase.getBeats() }}</mat-card-footer>
      } 
      @else {
        @if(activePhrase.mode === 'content') {
          <input type="text" name="phrase-input" class="phrase-input" value="{{ phrase.content }}" (keydown.enter)="saveAndCloseContentEditor($index)" (blur)="saveAndCloseContentEditor($index)" #active>
        }
        @else if (activePhrase.mode === 'notepad') {
          <textarea name="phrase-textarea" class="phrase-textarea" cols="{{ screenWidth / 14 }}" rows="{{ screenHeight / 36 }}" value="{{ phrase.content }}" (blur)="saveAndCloseContentEditor($index)" #active></textarea>
        }
        @else if (activePhrase.mode === 'time') {
          <mat-card-footer>{{ phrase.content }}</mat-card-footer>
          <input type="range" name="timeSlider" id="time-slider" value="{{phrase.duration}}" min="{{activePhrase.stepSize}}" max="{{activePhrase.stepSize * 128}}" step="{{activePhrase.stepSize}}" (change)="phrase.duration = timeSlider.valueAsNumber" list="steplist" #timeSlider>
          <label for="time-slider" id="time-slider-label">
            <button (click)="timeNotchDown($index)"><mat-icon>keyboard_arrow_left</mat-icon></button>
            <b>{{phrase.getBeats()}}</b>
            <button (click)="timeNotchUp($index)"><mat-icon>keyboard_arrow_right</mat-icon></button>
          </label>
          <button (click)="timeCtrlToggleStep()">{{timeCtrlGetStepContext()}}</button>
        }
        @else {
          <mat-card-content class="phrase-input">{{ phrase.content }}</mat-card-content>
        }

        <mat-card-actions class="phrase-card-actions">
          <button mat-button (click)="toggleContentMode()"><mat-icon>create</mat-icon></button>
          <button mat-button (click)="toggleTimeMode()"><mat-icon>timer</mat-icon></button>
          <button mat-button [matMenuTriggerFor]="phraseMenu" (click)="activePhrase.mode = 'menu'"><mat-icon>menu</mat-icon></button>
          @if(activePhrase.mode === 'notepad' || activePhrase.mode === 'content') {
            <button mat-button (click)="saveAndCloseContentEditor($index)"><mat-icon>save</mat-icon></button>
          }
        </mat-card-actions>

        <mat-menu #phraseMenu>
          <button mat-menu-item (click)="activePhrase.mode = 'notepad'">Notepad mode</button>
          <button mat-menu-item [matMenuTriggerFor]="splitMenu" (click)="activePhrase.mode = 'menu'">Split</button>
          <button mat-menu-item [matMenuTriggerFor]="mergeMenu" (click)="activePhrase.mode = 'menu'">Merge</button>
          <button mat-menu-item (click)="duplicatePhrase($index)">Duplicate</button>
          <button mat-menu-item (click)="deletePhrase($index)">Delete</button>
        </mat-menu>

        <mat-menu #splitMenu>
          <button mat-menu-item (click)="activePhrase.mode = 'split'">Interactive split</button>
          <button mat-menu-item (click)="splitPhraseByWord($index)">Split by word</button>
        </mat-menu>
        
        <mat-menu #mergeMenu>
          @if($first) {
            <button mat-menu-item disabled>Left merge</button>
          } @else {
            <button mat-menu-item (click)="mergePhraseLeft($index)">Left merge</button>
          }
          @if($last) {
            <button mat-menu-item disabled>Right merge</button>
          } @else {
            <button mat-menu-item (click)="mergePhraseRight($index)">Right merge</button>
          }
        </mat-menu>

      } 

    </mat-card>

    @if (isNextBar(phrase.duration, $first) || (activePhrase.mode === 'notepad' && activePhrase.index === $index)) { 
      <div class="break"></div>
    } 
  } 

    <div class="break"></div>
    <mat-card id="add-new-phrase-card">
      <mat-card-content>
        <button id="add-new-phrase-btn" (click)="addPhrase(); activePhrase.index = page.lyrics.length - 1; activePhrase.mode = 'notepad'"><mat-icon inline="true">add</mat-icon></button>
      </mat-card-content>
    </mat-card>

  </div>
</div>