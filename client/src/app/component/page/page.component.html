<div id="page-container">
  <div id="page-header-div">
    <button id="page-close" mat-raised-button color="primary" (click)="dialogRef.close()"><mat-icon>close</mat-icon></button>
    <div>
      <input type="text" name="page-title" id="page-title" placeholder="{{placeholderTitle}}" (change)="saveTitle(title.value)" (click)="placeholderTitle = ''" (blur)="placeholderTitle = page.title" #title>
    </div>   
  </div>
  <!-- Toolbar here -->
  <button (click)="splitLyricsByWord()">Split by Word</button>

  <div id="lyric-cards-container">
  @for (phrase of page.lyrics; track $index) {


    @if(activePhrase.mode === 'notepad' && activePhrase.index === $index && !$first) {
      <div class="break"></div>
    }

    <mat-card class="phrase-card" (click)="toggleActive($index)">
      
      @if(activePhrase.index === $index) {
        @if(activePhrase.mode === 'content') {
          <input type="text" name="phrase-input" class="phrase-input" value="{{ phrase.content }}" (keydown.enter)="saveAndCloseContentEditor(active.value, $index, false)" (blur)="saveAndCloseContentEditor(active.value, $index, true)" #active>
        }
        @else if (activePhrase.mode === 'notepad') {
          <textarea name="phrase-textarea" class="phrase-textarea" cols="{{ screenWidth / 14 }}" rows="{{ screenHeight / 36 }}" value="{{ phrase.content }}" (blur)="saveAndCloseContentEditor(active.value, $index, true)" #active></textarea>
        }
        @else {
          <mat-card-content class="phrase-input">{{ phrase.content }}</mat-card-content>
        }
      } 
      @else {
        <mat-card-title>{{ phrase.content }}</mat-card-title>
        <mat-card-footer>Length: {{ phrase.getBeats() }}</mat-card-footer>
      }
      @if(activePhrase.index == $index) {
        <mat-card-actions class="phrase-card-actions">
          <button mat-button (click)="activePhrase.mode = 'content'"><mat-icon>create</mat-icon></button>
          <button mat-button [matMenuTriggerFor]="timeMenu" (click)="activePhrase.mode = 'menu'; timeMenuSetDefault()"><mat-icon>timer</mat-icon></button>
          <button mat-button [matMenuTriggerFor]="phraseMenu" (click)="activePhrase.mode = 'menu'"><mat-icon>menu</mat-icon></button>
        </mat-card-actions>

        <mat-menu #timeMenu (click)="activePhrase.mode = 'menu'">
          <span mat-menu-item>
            <input type="range" name="timeSlider" id="timeSlider" min="{{activePhrase.stepSize}}" max="{{activePhrase.stepSize * 256}}" step="{{activePhrase.stepSize}}" (change)="phrase.duration = timeSlider.valueAsNumber" #timeSlider>
            <label for="timeSlider">{{phrase.getBeatsFromInput(timeSlider.valueAsNumber)}}</label>
            <button (click)="timeMenuToggleStep()">{{timeMenuGetStepContext()}}</button>
          </span>
        </mat-menu>

        <mat-menu #phraseMenu>
          <button mat-menu-item (click)="activePhrase.mode = 'notepad'">Notepad mode</button>
          <button mat-menu-item [matMenuTriggerFor]="splitMenu" (click)="activePhrase.mode = 'menu'">Split</button>
          <button mat-menu-item [matMenuTriggerFor]="mergeMenu" (click)="activePhrase.mode = 'menu'">Merge</button>
          <button mat-menu-item (click)="duplicatePhrase($index)">Duplicate</button>
          <button mat-menu-item (click)="deletePhrase($index)">Delete</button>
        </mat-menu>

        <mat-menu #splitMenu>
          <button mat-menu-item (click)="activePhrase.mode = 'notepad'">Interactive split</button>
          <button mat-menu-item disabled>Split by word</button>
          <button mat-menu-item disabled>Split by line</button>
        </mat-menu>
        
        <mat-menu #mergeMenu>
          <button mat-menu-item disabled>Left merge</button>
          <button mat-menu-item disabled>Right merge</button>
        </mat-menu>
      }

    </mat-card>

    @if (isNextBar(phrase.duration, $first) || (activePhrase.mode === 'notepad' && activePhrase.index === $index)) { 
      <div class="break"></div>
    } 
  } 

    <div class="break"></div>
    <mat-card id="add-new-phrase-card">
      <mat-card-content>
        <button id="add-new-phrase-btn" (click)="addPhrase(); activePhrase.index = page.lyrics.length - 1; activePhrase.mode = 'notepad'"><mat-icon inline="true">add</mat-icon></button>
      </mat-card-content>
    </mat-card>

  </div>
</div>